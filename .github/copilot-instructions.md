# Kuadrat AI Guide
- **Monorepo layout**: `api/` (Express + Turso) and `client/` (Next.js 15 App Router). Shared docs (`API_ENDPOINTS.md`, `DATABASE_SCHEMA.md`) are the canonical source for schema and contract updates—sync changes in both tiers.
- **Backend startup**: `api/server.js` bootstraps Express, initializes Turso via `initializeDatabase()` and verifies SMTP. Local dev runs with `npm run dev`; Docker compose exposes API on `3001` and client on `3000`.
- **Database access**: All queries go through `@libsql/client` (`config/database.js`). Prefer parameterized `db.execute({ sql, args })`. The initializer also runs ad-hoc migrations; if you change table shapes, extend that function instead of adding ORM-style migrations.
- **Auth stack**: Passport local strategy validates email/password against `users.password_hash`; JWT strategy gates protected routes. Use `authenticate` and role guards from `middleware/authorization.js` (seller-only vs buyer-access). Admin APIs require both `authenticate` and `middleware/adminAuth.js`.
- **Error model**: Throw `ApiError` or `ValidationError` from `middleware/errorHandler.js` so clients receive `{ success:false, status, title, message, errors[] }`. Reuse this shape on new endpoints and bubble errors to the centralized handler.
- **File handling**: Public product assets live under `api/uploads/products`, author avatars under `api/uploads/authors`. `productsRoutes` expects multipart uploads with field `image` (multer memory storage, min 600x600 enforced in `createProduct`). When adding features, persist files via the same directories and expose through dedicated routes (`/products/images/:basename`).
- **Orders flow**: `ordersController.js` treats `orders`/`order_items` as transactional; expect to mark `products.is_sold = 1` per line item. If you add bulk operations, keep this flag in sync to avoid selling sold pieces.
- **Email service**: `services/emailService.js` wraps Nodemailer. Hook new notifications into this module; it already exposes `verifyTransporter`, `sendPurchaseConfirmation`, and `sendRegistrationRequest` and reads SMTP config from `api/.env`.
- **Admin tooling**: Seed an admin via `node create-admin.js` (defaults to admin@test.com/admin123). Admin endpoints under `/api/admin` support author management and product moderation, using `multer.diskStorage`; mirror their conventions when extending CMS functionality.
- **Testing**: `cd api && npm test` runs Jest + Supertest against the live Express app; tests currently insert fixtures directly through `db.execute`. If you change request payloads (e.g., image uploads) update the tests or provide test helpers that supply multipart data.
- **Client data layer**: `client/lib/api.js` centralizes fetch logic, auto-attaches JWT from `localStorage`, handles FormData vs JSON, and triggers logout on 401. Reuse these helpers—do not call `fetch` directly in components.
- **Auth UX**: Wrap gated pages in `<AuthGuard requireRole="seller" />` or omit `requireRole` for any authenticated user. Guard redirects unauthenticated users to `/autores`, so make sure that page remains publicly accessible.
- **Notifications**: Surface API failures through `useNotification().showApiError(error)` to render consistent toasts via `NotificationContext` + `Notification.js`.
- **Gallery patterns**: Infinite scroll and author filters in `app/galeria/page.js` illustrate how to call `productsAPI.getAll` with `author_slug` and category filters. Follow that pattern for other paginated views.
- **Rich text editing**: Admin product editor uses `QuillEditor` (wrapper around `quill` with Tailwind styling in `components/QuillEditor.js`). When adding rich-text fields, reuse this component to keep formatting consistent.
- **Image previews**: Client-side validation in admin edit page enforces 600x600 and allowed mime types before hitting the API. Mirror these checks in new upload flows to avoid back-end validation errors.
- **Environment variables**: API expects Turso creds (`TURSO_DATABASE_URL`, `TURSO_AUTH_TOKEN`), JWT settings, SMTP, and `CLIENT_URL`. Client reads `NEXT_PUBLIC_API_URL`. Keep Docker `.env` files in sync when changing defaults.
- **Sockets**: `server.js` wires Socket.IO and stores the instance on `app.set('io')`. Auction events are placeholders—if you implement them, emit to rooms named `auction-${id}` to match the join/leave helpers.
- **Deployment**: Docker is the canonical path (`docker-compose up --build`). Ensure `uploads/` directories persist or mount volumes; otherwise image uploads vanish across restarts.
- **Coding style**: Front-end favors `use client` components with Tailwind classes and Spanish copy. Back-end responses use Spanish messages; maintain this localization.
- **Docs to update**: On API or schema changes, revise `API_ENDPOINTS.md`, `DATABASE_SCHEMA.md`, and mention new admin workflows in `README.md`.
- **When unsure**: Check existing controllers/routes before adding new ones—most logic already lives there and new features should slot into the existing patterns.
